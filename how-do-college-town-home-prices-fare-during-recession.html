<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>How do college-town home prices fare during a recession? - Data and Code</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/how-do-college-town-home-prices-fare-during-recession.html">

        <meta name="author" content="Rob Osterburg" />
        <meta name="keywords" content="pandas,statistics,analysis wrangling,seaborn,scipy.stats,ttest_ind,boxplot,violinplot,timeseries,quarterly data,quarter,datetime,datetimeindex,read_csv,read_excel" />
        <meta name="description" content="During a recession, home prices suffer. How do college towns compare to other communities? Let&#39;s find out. But first, a few definitions. A quarter is a specific three month period, Q1 is January through March, Q2 is April through June, Q3 is July through September, Q4 is October through December …" />

        <meta property="og:site_name" content="Data and Code" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="How do college-town home prices fare during a recession?"/>
        <meta property="og:url" content="/how-do-college-town-home-prices-fare-during-recession.html"/>
        <meta property="og:description" content="During a recession, home prices suffer. How do college towns compare to other communities? Let&#39;s find out. But first, a few definitions. A quarter is a specific three month period, Q1 is January through March, Q2 is April through June, Q3 is July through September, Q4 is October through December …"/>
        <meta property="article:published_time" content="2019-05-30" />
            <meta property="article:section" content="Data Science" />
            <meta property="article:tag" content="pandas" />
            <meta property="article:tag" content="statistics" />
            <meta property="article:tag" content="analysis wrangling" />
            <meta property="article:tag" content="seaborn" />
            <meta property="article:tag" content="scipy.stats" />
            <meta property="article:tag" content="ttest_ind" />
            <meta property="article:tag" content="boxplot" />
            <meta property="article:tag" content="violinplot" />
            <meta property="article:tag" content="timeseries" />
            <meta property="article:tag" content="quarterly data" />
            <meta property="article:tag" content="quarter" />
            <meta property="article:tag" content="datetime" />
            <meta property="article:tag" content="datetimeindex" />
            <meta property="article:tag" content="read_csv" />
            <meta property="article:tag" content="read_excel" />
            <meta property="article:author" content="Rob Osterburg" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>



</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Data and Code            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="/category/data-engineering.html">Data engineering</a>
                        </li>
                        <li class="active">
                            <a href="/category/data-science.html">Data science</a>
                        </li>
                        <li >
                            <a href="/category/tutorial.html">Tutorial</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/how-do-college-town-home-prices-fare-during-recession.html"
                       rel="bookmark"
                       title="Permalink to How do college-town home prices fare during a recession?">
                        How do college-town home prices fare during a recession?
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2019-05-30T00:00:00-06:00"> Thu 30 May 2019</time>
    </span>


            <span class="label label-default">By</span>
            <a href="/author/rob-osterburg.html"><i class="fa fa-user"></i> Rob Osterburg</a>



<span class="label label-default">Tags</span>
	<a href="/tag/pandas.html">pandas</a>
        /
	<a href="/tag/statistics.html">statistics</a>
        /
	<a href="/tag/analysis-wrangling.html">analysis wrangling</a>
        /
	<a href="/tag/seaborn.html">seaborn</a>
        /
	<a href="/tag/scipystats.html">scipy.stats</a>
        /
	<a href="/tag/ttest_ind.html">ttest_ind</a>
        /
	<a href="/tag/boxplot.html">boxplot</a>
        /
	<a href="/tag/violinplot.html">violinplot</a>
        /
	<a href="/tag/timeseries.html">timeseries</a>
        /
	<a href="/tag/quarterly-data.html">quarterly data</a>
        /
	<a href="/tag/quarter.html">quarter</a>
        /
	<a href="/tag/datetime.html">datetime</a>
        /
	<a href="/tag/datetimeindex.html">datetimeindex</a>
        /
	<a href="/tag/read_csv.html">read_csv</a>
        /
	<a href="/tag/read_excel.html">read_excel</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>During a recession, home prices suffer.  How do college towns compare to other communities?  Let's find out.  But first, a few definitions.  </p>
<ul>
<li>
<p>A <em>quarter</em> is a specific three month period, Q1 is January through March, Q2 is April through June, Q3 is July through September, Q4 is October through December.</p>
</li>
<li>
<p>A <em>recession</em> is defined as starting with two consecutive quarters of GDP decline and ending with two consecutive quarters of GDP growth.</p>
</li>
<li>
<p>A <em>recession bottom</em> is the quarter within a recession, that had the lowest GDP.</p>
</li>
<li>
<p>A <em>university town</em> is a city that has a high percentage of college students compared to the total population of the city.</p>
</li>
</ul>
<h2>Hypothesis</h2>
<p><strong>College towns have their mean housing prices less affected by recessions. Run a t-test to compare the ratio of the mean price of houses in university towns the quarter before the recession starts compared to the recession bottom.  Values less than one show home price increases, and values greater than one, show home price declines.</strong></p>
<h2>Data</h2>
<ul>
<li>
<p>From the <a href="http://www.zillow.com/research/data/">Zillow research data site</a> there is housing data for the United States. In particular, the data file for <a href="http://files.zillowstatic.com/research/public/City/City_Zhvi_AllHomes.csv">all homes at a city level</a>, <code>zillow_homes_prices_by_city.csv</code>, has median home sale prices at a fine-grained level.</p>
</li>
<li>
<p>From the Wikipedia page on college towns is a list of <a href="https://en.wikipedia.org/wiki/List_of_college_towns#College_towns_in_the_United_States">college towns in the United States</a>  and saved as <code>college_towns.txt</code>.</p>
</li>
<li>
<p>From Bureau of Economic Analysis, US Department of Commerce, the <a href="http://www.bea.gov/national/index.htm#gdp">GDP over time</a> of the United States in current dollars (use the chained value in 2009 dollars), in quarterly intervals, in the file <code>gdplev.xls</code>. For this project, I only look at GDP data from the first quarter of 2000 onward.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ttest_ind</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Use fully spelled out place names</span>
<span class="n">states</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;OH&#39;</span><span class="p">:</span> <span class="s1">&#39;Ohio&#39;</span><span class="p">,</span> <span class="s1">&#39;KY&#39;</span><span class="p">:</span> <span class="s1">&#39;Kentucky&#39;</span><span class="p">,</span> <span class="s1">&#39;AS&#39;</span><span class="p">:</span> <span class="s1">&#39;American Samoa&#39;</span><span class="p">,</span> <span class="s1">&#39;NV&#39;</span><span class="p">:</span> <span class="s1">&#39;Nevada&#39;</span><span class="p">,</span> <span class="s1">&#39;WY&#39;</span><span class="p">:</span> <span class="s1">&#39;Wyoming&#39;</span><span class="p">,</span> <span class="s1">&#39;NA&#39;</span><span class="p">:</span> <span class="s1">&#39;National&#39;</span><span class="p">,</span> <span class="s1">&#39;AL&#39;</span><span class="p">:</span> <span class="s1">&#39;Alabama&#39;</span><span class="p">,</span> <span class="s1">&#39;MD&#39;</span><span class="p">:</span> <span class="s1">&#39;Maryland&#39;</span><span class="p">,</span> <span class="s1">&#39;AK&#39;</span><span class="p">:</span> <span class="s1">&#39;Alaska&#39;</span><span class="p">,</span> <span class="s1">&#39;UT&#39;</span><span class="p">:</span> <span class="s1">&#39;Utah&#39;</span><span class="p">,</span> <span class="s1">&#39;OR&#39;</span><span class="p">:</span> <span class="s1">&#39;Oregon&#39;</span><span class="p">,</span> <span class="s1">&#39;MT&#39;</span><span class="p">:</span> <span class="s1">&#39;Montana&#39;</span><span class="p">,</span> <span class="s1">&#39;IL&#39;</span><span class="p">:</span> <span class="s1">&#39;Illinois&#39;</span><span class="p">,</span> <span class="s1">&#39;TN&#39;</span><span class="p">:</span> <span class="s1">&#39;Tennessee&#39;</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">:</span> <span class="s1">&#39;District of Columbia&#39;</span><span class="p">,</span> <span class="s1">&#39;VT&#39;</span><span class="p">:</span> <span class="s1">&#39;Vermont&#39;</span><span class="p">,</span> <span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="s1">&#39;Idaho&#39;</span><span class="p">,</span> <span class="s1">&#39;AR&#39;</span><span class="p">:</span> <span class="s1">&#39;Arkansas&#39;</span><span class="p">,</span> <span class="s1">&#39;ME&#39;</span><span class="p">:</span> <span class="s1">&#39;Maine&#39;</span><span class="p">,</span> <span class="s1">&#39;WA&#39;</span><span class="p">:</span> <span class="s1">&#39;Washington&#39;</span><span class="p">,</span> <span class="s1">&#39;HI&#39;</span><span class="p">:</span> <span class="s1">&#39;Hawaii&#39;</span><span class="p">,</span> <span class="s1">&#39;WI&#39;</span><span class="p">:</span> <span class="s1">&#39;Wisconsin&#39;</span><span class="p">,</span> <span class="s1">&#39;MI&#39;</span><span class="p">:</span> <span class="s1">&#39;Michigan&#39;</span><span class="p">,</span> <span class="s1">&#39;IN&#39;</span><span class="p">:</span> <span class="s1">&#39;Indiana&#39;</span><span class="p">,</span> <span class="s1">&#39;NJ&#39;</span><span class="p">:</span> <span class="s1">&#39;New Jersey&#39;</span><span class="p">,</span> <span class="s1">&#39;AZ&#39;</span><span class="p">:</span> <span class="s1">&#39;Arizona&#39;</span><span class="p">,</span> <span class="s1">&#39;GU&#39;</span><span class="p">:</span> <span class="s1">&#39;Guam&#39;</span><span class="p">,</span> <span class="s1">&#39;MS&#39;</span><span class="p">:</span> <span class="s1">&#39;Mississippi&#39;</span><span class="p">,</span> <span class="s1">&#39;PR&#39;</span><span class="p">:</span> <span class="s1">&#39;Puerto Rico&#39;</span><span class="p">,</span> <span class="s1">&#39;NC&#39;</span><span class="p">:</span> <span class="s1">&#39;North Carolina&#39;</span><span class="p">,</span> <span class="s1">&#39;TX&#39;</span><span class="p">:</span> <span class="s1">&#39;Texas&#39;</span><span class="p">,</span> <span class="s1">&#39;SD&#39;</span><span class="p">:</span> <span class="s1">&#39;South Dakota&#39;</span><span class="p">,</span> <span class="s1">&#39;MP&#39;</span><span class="p">:</span> <span class="s1">&#39;Northern Mariana Islands&#39;</span><span class="p">,</span> <span class="s1">&#39;IA&#39;</span><span class="p">:</span> <span class="s1">&#39;Iowa&#39;</span><span class="p">,</span> <span class="s1">&#39;MO&#39;</span><span class="p">:</span> <span class="s1">&#39;Missouri&#39;</span><span class="p">,</span> <span class="s1">&#39;CT&#39;</span><span class="p">:</span> <span class="s1">&#39;Connecticut&#39;</span><span class="p">,</span> <span class="s1">&#39;WV&#39;</span><span class="p">:</span> <span class="s1">&#39;West Virginia&#39;</span><span class="p">,</span> <span class="s1">&#39;SC&#39;</span><span class="p">:</span> <span class="s1">&#39;South Carolina&#39;</span><span class="p">,</span> <span class="s1">&#39;LA&#39;</span><span class="p">:</span> <span class="s1">&#39;Louisiana&#39;</span><span class="p">,</span> <span class="s1">&#39;KS&#39;</span><span class="p">:</span> <span class="s1">&#39;Kansas&#39;</span><span class="p">,</span> <span class="s1">&#39;NY&#39;</span><span class="p">:</span> <span class="s1">&#39;New York&#39;</span><span class="p">,</span> <span class="s1">&#39;NE&#39;</span><span class="p">:</span> <span class="s1">&#39;Nebraska&#39;</span><span class="p">,</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span> <span class="s1">&#39;Oklahoma&#39;</span><span class="p">,</span> <span class="s1">&#39;FL&#39;</span><span class="p">:</span> <span class="s1">&#39;Florida&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">:</span> <span class="s1">&#39;California&#39;</span><span class="p">,</span> <span class="s1">&#39;CO&#39;</span><span class="p">:</span> <span class="s1">&#39;Colorado&#39;</span><span class="p">,</span> <span class="s1">&#39;PA&#39;</span><span class="p">:</span> <span class="s1">&#39;Pennsylvania&#39;</span><span class="p">,</span> <span class="s1">&#39;DE&#39;</span><span class="p">:</span> <span class="s1">&#39;Delaware&#39;</span><span class="p">,</span> <span class="s1">&#39;NM&#39;</span><span class="p">:</span> <span class="s1">&#39;New Mexico&#39;</span><span class="p">,</span> <span class="s1">&#39;RI&#39;</span><span class="p">:</span> <span class="s1">&#39;Rhode Island&#39;</span><span class="p">,</span> <span class="s1">&#39;MN&#39;</span><span class="p">:</span> <span class="s1">&#39;Minnesota&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="s1">&#39;Virgin Islands&#39;</span><span class="p">,</span> <span class="s1">&#39;NH&#39;</span><span class="p">:</span> <span class="s1">&#39;New Hampshire&#39;</span><span class="p">,</span> <span class="s1">&#39;MA&#39;</span><span class="p">:</span> <span class="s1">&#39;Massachusetts&#39;</span><span class="p">,</span> <span class="s1">&#39;GA&#39;</span><span class="p">:</span> <span class="s1">&#39;Georgia&#39;</span><span class="p">,</span> <span class="s1">&#39;ND&#39;</span><span class="p">:</span> <span class="s1">&#39;North Dakota&#39;</span><span class="p">,</span> <span class="s1">&#39;VA&#39;</span><span class="p">:</span> <span class="s1">&#39;Virginia&#39;</span><span class="p">}</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_list_of_university_towns</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns a DataFrame of towns and the states they are in from the </span>
<span class="sd">    university_towns.txt list. The format of the DataFrame should be:</span>
<span class="sd">    DataFrame( [ [&quot;Michigan&quot;, &quot;Ann Arbor&quot;], [&quot;Michigan&quot;, &quot;Yipsilanti&quot;] ], </span>
<span class="sd">    columns=[&quot;State&quot;, &quot;RegionName&quot;]  )</span>

<span class="sd">    Accomplish the following cleaning:</span>

<span class="sd">    1. For &quot;State&quot;, removing characters from &quot;[&quot; to the end.</span>
<span class="sd">    2. For &quot;RegionName&quot;, when applicable, removing every character from &quot; (&quot; to the end.</span>
<span class="sd">    3. Depending on how you read the data, you may need to remove newline character &#39;\n&#39;. &quot;&quot;&quot;</span>

    <span class="n">towns_by_state</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">towns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/college_towns.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;[edit]&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">towns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">towns_by_state</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">towns</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">towns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">))</span> <span class="p">:</span>
                <span class="n">town</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">towns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">town</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">town</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">towns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">town</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">town</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">towns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">town</span><span class="p">)</span>
    <span class="n">state_town_tups</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="n">town</span><span class="p">))</span> <span class="k">for</span> <span class="n">state</span><span class="p">,</span> <span class="n">towns</span> <span class="ow">in</span> <span class="n">towns_by_state</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">town</span> <span class="ow">in</span> <span class="n">towns</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">state_town_tups</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;RegionName&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">get_list_of_university_towns</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>State</th>
      <th>RegionName</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>North Dakota</td>
      <td>Fargo</td>
    </tr>
    <tr>
      <th>1</th>
      <td>North Dakota</td>
      <td>Grand Forks</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Colorado</td>
      <td>Alamosa</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Colorado</td>
      <td>Boulder</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Colorado</td>
      <td>Durango</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gdp_data</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a dataframe containing the quarterly GDP data expressed in 2009 dollars.&quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;data/gdplev.xls&#39;</span><span class="p">,</span> 
        <span class="n">skiprows</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> 
        <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> 
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;qtr&#39;</span><span class="p">,</span> <span class="s1">&#39;gdp_curr&#39;</span><span class="p">,</span> <span class="s1">&#39;gdp_2009&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">gdp_data</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>qtr</th>
      <th>gdp_curr</th>
      <th>gdp_2009</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1947q1</td>
      <td>243.1</td>
      <td>1934.5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1947q2</td>
      <td>246.3</td>
      <td>1932.3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1947q3</td>
      <td>250.1</td>
      <td>1930.3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1947q4</td>
      <td>260.3</td>
      <td>1960.7</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1948q1</td>
      <td>266.2</td>
      <td>1989.5</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><span class="c1"># better approach</span>
<span class="k">def</span> <span class="nf">qtr_to_prd</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the provided dataframe converting the quarterly dates expressed as strings</span>
<span class="sd">    to Pandas&#39; Period objects contained in the &#39;date&#39; column, year in the &#39;year&#39; column</span>
<span class="sd">    and the number of the quarter in the &#39;qtr&#39; column. &quot;&quot;&quot;</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">qtr</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;qtr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">quarter</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">qtr_to_prd</span><span class="p">(</span><span class="n">gdp_data</span><span class="p">())</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>qtr</th>
      <th>gdp_curr</th>
      <th>gdp_2009</th>
      <th>date</th>
      <th>year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>243.1</td>
      <td>1934.5</td>
      <td>1947Q1</td>
      <td>1947</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>246.3</td>
      <td>1932.3</td>
      <td>1947Q2</td>
      <td>1947</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>250.1</td>
      <td>1930.3</td>
      <td>1947Q3</td>
      <td>1947</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>260.3</td>
      <td>1960.7</td>
      <td>1947Q4</td>
      <td>1947</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>266.2</td>
      <td>1989.5</td>
      <td>1948Q1</td>
      <td>1948</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><span class="c1"># an alternate approach using pandas &quot;str&quot; accessor</span>
<span class="k">def</span> <span class="nf">qrt_to_dt</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the provided dataframe converting the quarterly dates expressed as strings</span>
<span class="sd">    to Pandas&#39; Period objects contained in the &#39;date&#39; column, year in the &#39;year&#39; column</span>
<span class="sd">    and the number of the quarter in the &#39;qtr&#39; column. &quot;&quot;&quot;</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">qtr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;qtr&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;qtr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gdp_change</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a Series containing the differences between an element </span>
<span class="sd">    and the value in the previous row of the gdp_2009 column.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">gdp_2009</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_increasing</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a Series of floating point values containing 1.0 if the value</span>
<span class="sd">    in the &#39;delta&#39; column is greater than 0, otherwise 0.0 is returned.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">gdp_data</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">qtr_to_prd</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdp_change</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;increasing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_increasing</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>qtr</th>
      <th>gdp_curr</th>
      <th>gdp_2009</th>
      <th>year</th>
      <th>delta</th>
      <th>increasing</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1947Q1</th>
      <td>1</td>
      <td>243.1</td>
      <td>1934.5</td>
      <td>1947</td>
      <td>NaN</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1947Q2</th>
      <td>2</td>
      <td>246.3</td>
      <td>1932.3</td>
      <td>1947</td>
      <td>-2.2</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1947Q3</th>
      <td>3</td>
      <td>250.1</td>
      <td>1930.3</td>
      <td>1947</td>
      <td>-2.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1947Q4</th>
      <td>4</td>
      <td>260.3</td>
      <td>1960.7</td>
      <td>1947</td>
      <td>30.4</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1948Q1</th>
      <td>1</td>
      <td>266.2</td>
      <td>1989.5</td>
      <td>1948</td>
      <td>28.8</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">recession_prep</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the dataframe with columns added that support analysis of recessions.</span>
<span class="sd">    In particular, determine if GDP is increasing or decreasing by using the shift method</span>
<span class="sd">    to create a Series of duplicated values that have been shifted by the number of</span>
<span class="sd">    rows specified.  Together the shifted columns allow for the quarter in which a recession</span>
<span class="sd">    starts and ends is identified.&quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">qtr_to_prd</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdp_change</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;increasing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_increasing</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prv1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;increasing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># look back one</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prv2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;increasing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;curr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;increasing&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nxt1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;increasing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># look ahead one</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nxt2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;increasing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prv1&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;curr&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nxt1&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prv2&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prv1&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;curr&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">recession_prep</span><span class="p">(</span><span class="n">gdp_data</span><span class="p">())</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2007q3&#39;</span><span class="p">:</span><span class="s1">&#39;2010q4&#39;</span><span class="p">]</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>qtr</th>
      <th>gdp_curr</th>
      <th>gdp_2009</th>
      <th>year</th>
      <th>delta</th>
      <th>increasing</th>
      <th>prv1</th>
      <th>prv2</th>
      <th>curr</th>
      <th>nxt1</th>
      <th>nxt2</th>
      <th>start</th>
      <th>end</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2007Q3</th>
      <td>3</td>
      <td>14569.7</td>
      <td>14938.5</td>
      <td>2007</td>
      <td>99.8</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2007Q4</th>
      <td>4</td>
      <td>14685.3</td>
      <td>14991.8</td>
      <td>2007</td>
      <td>53.3</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2008Q1</th>
      <td>1</td>
      <td>14668.4</td>
      <td>14889.5</td>
      <td>2008</td>
      <td>-102.3</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2008Q2</th>
      <td>2</td>
      <td>14813.0</td>
      <td>14963.4</td>
      <td>2008</td>
      <td>73.9</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2008Q3</th>
      <td>3</td>
      <td>14843.0</td>
      <td>14891.6</td>
      <td>2008</td>
      <td>-71.8</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2008Q4</th>
      <td>4</td>
      <td>14549.9</td>
      <td>14577.0</td>
      <td>2008</td>
      <td>-314.6</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2009Q1</th>
      <td>1</td>
      <td>14383.9</td>
      <td>14375.0</td>
      <td>2009</td>
      <td>-202.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2009Q2</th>
      <td>2</td>
      <td>14340.4</td>
      <td>14355.6</td>
      <td>2009</td>
      <td>-19.4</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2009Q3</th>
      <td>3</td>
      <td>14384.1</td>
      <td>14402.5</td>
      <td>2009</td>
      <td>46.9</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2009Q4</th>
      <td>4</td>
      <td>14566.5</td>
      <td>14541.9</td>
      <td>2009</td>
      <td>139.4</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2010Q1</th>
      <td>1</td>
      <td>14681.1</td>
      <td>14604.8</td>
      <td>2010</td>
      <td>62.9</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2010Q2</th>
      <td>2</td>
      <td>14888.6</td>
      <td>14745.9</td>
      <td>2010</td>
      <td>141.1</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2010Q3</th>
      <td>3</td>
      <td>15057.7</td>
      <td>14845.5</td>
      <td>2010</td>
      <td>99.6</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2010Q4</th>
      <td>4</td>
      <td>15230.2</td>
      <td>14939.0</td>
      <td>2010</td>
      <td>93.5</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_recessions</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return list of tuples containing the starting and ending dates for recessions.&quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2000q1&#39;</span><span class="p">:]</span>
    <span class="n">recessions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">is_recession</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">is_recession</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">is_recession</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">is_recession</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">recessions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Yq%q&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Yq%q&#39;</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">recessions</span>

<span class="n">get_recessions</span><span class="p">(</span><span class="n">recession_prep</span><span class="p">(</span><span class="n">gdp_data</span><span class="p">()))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;2008q3&#39;</span><span class="p">,</span> <span class="s1">&#39;2009q4&#39;</span><span class="p">)]</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_recession_start</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the year and quarter of the recession start time as a</span>
<span class="sd">    string value in a format such as 2005q3.&quot;&quot;&quot;</span>

    <span class="c1"># only one recession during this period, so no need to loop over start, end tuples</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">get_recessions</span><span class="p">(</span><span class="n">recession_prep</span><span class="p">(</span><span class="n">gdp_data</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">start</span>

<span class="n">get_recession_start</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="s1">&#39;2008q3&#39;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_recession_end</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the year and quarter of the recession end time as a</span>
<span class="sd">    string value in a format such as 2005q3.&quot;&quot;&quot;</span>

    <span class="c1"># only one recession during this period, so no need to loop over start, end tuples</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">get_recessions</span><span class="p">(</span><span class="n">recession_prep</span><span class="p">(</span><span class="n">gdp_data</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">end</span>

<span class="n">get_recession_end</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="s1">&#39;2009q4&#39;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_recession_bottom</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the year and quarter of the recession bottom time as a</span>
<span class="sd">    string value in a format such as 2005q3.&quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">recession_prep</span><span class="p">(</span><span class="n">gdp_data</span><span class="p">())</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">get_recessions</span><span class="p">(</span><span class="n">df</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="s1">&#39;gdp_2009&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Yq%q&#39;</span><span class="p">)</span>

<span class="n">get_recession_bottom</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="s1">&#39;2009q2&#39;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convert_housing_data_to_quarters</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Converts the housing data to quarters and returns it as mean</span>
<span class="sd">    values in a dataframe. This dataframe should be a dataframe with</span>
<span class="sd">    columns for 2000q1 through 2016q3, and should have a multi-index</span>
<span class="sd">    in the shape of [&quot;State&quot;,&quot;RegionName&quot;].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/zillow_homes_prices_by_city.csv&#39;</span><span class="p">,</span>
                 <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;RegionID&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;RegionName&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;State&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Metro&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;CountyName&#39;</span><span class="p">:</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;SizeRank&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">})</span>

    <span class="n">region_id_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;RegionID&#39;</span><span class="p">,</span> <span class="s1">&#39;RegionName&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Metro&#39;</span><span class="p">,</span> <span class="s1">&#39;CountyName&#39;</span><span class="p">,</span> <span class="s1">&#39;SizeRank&#39;</span><span class="p">]]</span>
    <span class="n">region_id_df</span> <span class="o">=</span> <span class="n">region_id_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">State</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">states</span><span class="p">))</span>
    <span class="n">region_id_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;RegionName&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Metro&#39;</span><span class="p">,</span> <span class="s1">&#39;CountyName&#39;</span><span class="p">,</span> <span class="s1">&#39;SizeRank&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                 <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RegionID&#39;</span><span class="p">],</span>
                 <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
                 <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;MedianSalesPrice&#39;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Date</span><span class="p">))</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2000-01-01&#39;</span><span class="p">:]</span>

    <span class="n">region_mean_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">),</span> <span class="s1">&#39;RegionID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">joined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">region_id_df</span><span class="p">,</span> <span class="n">region_mean_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;RegionID&#39;</span><span class="p">)</span>

    <span class="c1"># Note: Pivoting on State and RegionName without RegionID reduces the number of rows to 10592.</span>
    <span class="c1">#       Only by pivoting on all three and later dropping RegionID can I get the correct number of rows (10730)</span>
    <span class="c1">#       Finding this was truly painful.</span>
    <span class="n">pivot_df</span> <span class="o">=</span> <span class="n">joined_df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;RegionID&#39;</span><span class="p">,</span> <span class="s1">&#39;RegionName&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;MedianSalesPrice&#39;</span><span class="p">)</span>
    <span class="n">pivot_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">()]</span>
    <span class="n">pivot_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pivot_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;RegionID&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pivot_df</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># save dataframe as csv</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="s1">&#39;./data/effect_of_recession_on_median_home_prices.csv&#39;</span>
<span class="n">convert_housing_data_to_quarters</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_ttest</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;First creates new data showing the decline or growth of housing prices</span>
<span class="sd">    between the recession start and the recession bottom. Then runs a ttest</span>
<span class="sd">    comparing the university town values to non-university towns values,</span>
<span class="sd">    return whether the alternative hypothesis (that the two groups are the same)</span>
<span class="sd">    is true or not and its p-value. </span>

<span class="sd">    Return the tuple (different, p, better) where different=True if the t-test is</span>
<span class="sd">    True at a p&lt;0.01 (we reject the null hypothesis), or different=False, if </span>
<span class="sd">    otherwise (we cannot reject the null hypothesis). The variable p should</span>
<span class="sd">    be equal to the exact p-value returned from scipy.stats.ttest_ind(). The</span>
<span class="sd">    value for better should be either &quot;university town&quot; or &quot;non-university town&quot;</span>
<span class="sd">    depending on which has a lower mean price ratio (which is equivalent to a</span>
<span class="sd">    reduced market loss).&#39;&#39;&#39;</span>

    <span class="c1"># group university and non-university towns</span>
    <span class="n">univ_towns</span> <span class="o">=</span> <span class="n">get_list_of_university_towns</span><span class="p">()</span>
    <span class="n">univ_towns</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">univ_towns</span><span class="p">[[</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;RegionName&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># get home sales data</span>
    <span class="n">sales_df</span> <span class="o">=</span> <span class="n">convert_housing_data_to_quarters</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">sales_df</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales_df</span><span class="p">[[</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;RegionName&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># calculate the ratio of prices from the start to the bottom of the recession</span>
    <span class="c1"># smaller values indicates that homes retained their value during the recession</span>
    <span class="n">sales_df</span><span class="p">[</span><span class="s1">&#39;Price_Ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">get_recession_start</span><span class="p">()]</span> <span class="o">/</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">get_recession_bottom</span><span class="p">()]</span>
    <span class="n">sales_df</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;Price_Ratio&#39;</span><span class="p">]]</span>
    <span class="n">sales_df</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># home sales data series for university and other towns</span>
    <span class="n">is_univ</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">univ_towns</span><span class="o">.</span><span class="n">Location</span><span class="p">)</span>
    <span class="n">univ_sales_df</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_univ</span><span class="p">]</span>
    <span class="n">other_sales_df</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">is_univ</span><span class="p">]</span>

    <span class="c1"># compare the means of median home prices</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">ttest_ind</span><span class="p">(</span><span class="n">other_sales_df</span><span class="o">.</span><span class="n">Price_Ratio</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">univ_sales_df</span><span class="o">.</span><span class="n">Price_Ratio</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># interpret the results</span>
    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="c1"># reject null hypothesis --&gt; population means are different</span>
        <span class="n">different</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">better</span> <span class="o">=</span> <span class="s1">&#39;university town&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># accept null hypothesis --&gt; population means are the same</span>
        <span class="n">different</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">better</span> <span class="o">=</span> <span class="s1">&#39;non-university town&#39;</span>

    <span class="c1"># return results</span>
    <span class="k">return</span> <span class="n">different</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">better</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">run_ttest</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0050464756985043489</span><span class="p">,</span> <span class="s1">&#39;university town&#39;</span><span class="p">)</span>
</pre></div>


<hr>
<h2>Results</h2>
<p>Median home prices in college towns declined less than other towns during the recession that started in late 2008.  In this data set, betting on college towns appears to be a winner though there is a 1 in 100 chance that this conclusion is wrong. Let's dive in a little deeper into the data and see what it shows.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_plotting_frame</span><span class="p">():</span>
    <span class="c1"># group university and non-university towns</span>
    <span class="n">univ_towns</span> <span class="o">=</span> <span class="n">get_list_of_university_towns</span><span class="p">()</span>
    <span class="n">univ_towns</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">univ_towns</span><span class="p">[[</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;RegionName&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># get home sales data</span>
    <span class="n">sales_df</span> <span class="o">=</span> <span class="n">convert_housing_data_to_quarters</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">sales_df</span><span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales_df</span><span class="p">[[</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;RegionName&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># calculate a more intuitive price ratio where values above one represent price gains</span>
    <span class="n">sales_df</span><span class="p">[</span><span class="s1">&#39;Intuitive_Price_Ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">get_recession_bottom</span><span class="p">()]</span> <span class="o">/</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">get_recession_start</span><span class="p">()]</span>
    <span class="n">sales_df</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;Intuitive_Price_Ratio&#39;</span><span class="p">]]</span>
    <span class="n">sales_df</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># identify and label towns as either college or regular</span>
    <span class="n">sales_df</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Type</span><span class="o">=</span><span class="n">sales_df</span><span class="o">.</span><span class="n">Location</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">univ_towns</span><span class="o">.</span><span class="n">Location</span><span class="p">))</span>
    <span class="n">sales_df</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Town</span><span class="o">=</span><span class="n">sales_df</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="bp">True</span><span class="p">:</span><span class="s1">&#39;College&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">:</span><span class="s1">&#39;Regular&#39;</span><span class="p">}))</span>

    <span class="c1"># replace long state names with two letter abbreviations for plotting</span>
    <span class="n">reverse_state_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="nb">long</span><span class="p">:</span> <span class="n">short</span> <span class="k">for</span> <span class="n">short</span><span class="p">,</span> <span class="nb">long</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">sales_df</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">State</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">reverse_state_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sales_df</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">plot_df</span> <span class="o">=</span> <span class="n">create_plotting_frame</span><span class="p">()</span>
</pre></div>


<h3>Comparing College and Regular Towns</h3>
<p>A price ratio of greater than one indicates that median home prices increased during the recession and values less than one home price decreases.  The ratio is formed by dividing the value from the bottom by that of its start.  Looking closely at the plot reveals that college towns have a <em>subtly</em> higher median value (indicated by the line in the middle of the box) than other towns.  The median value is unaffected by outliers (shown as dots) that comprise less than 1% of all towns.  Home prices in college towns were more stable, showing less variance in home prices.</p>
<div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">:(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">)})</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Town&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Intuitive_Price_Ratio&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Town&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">plot_df</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">offset</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p><img alt="Box plot of home prices by town type" src="/images/college_towns_blog_post_28_0.png"></p>
<h3>State-Level Median Home Prices</h3>
<p>Let's see how values compare by state with New Mexico standing out as one of the housing markets during the recession.  The violin plot shows the distribution of home price values by town type for each state.</p>
<div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">:(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">6</span><span class="p">)})</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Intuitive_Price_Ratio&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Town&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">plot_df</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="p">.</span><span class="n">axes</span><span class="p">.</span><span class="n">_subplots</span><span class="p">.</span><span class="n">AxesSubplot</span> <span class="k">at</span> <span class="mi">0</span><span class="n">x11bc02390</span><span class="o">&gt;</span>
</pre></div>


<p><img alt="Violin plot of home prices by town type and state" src="/images/college_towns_blog_post_30_1.png"></p>
<h3>Best and Worst State Housing Markets</h3>
<p>How did home prices change on the state-level? Let's the best and worst states by sorting the price ratio and extract the states with the best and worst-performing home markets.  </p>
<ul>
<li>Best: New Mexico</li>
<li>Worst: Nevada</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># states with the best housing markets</span>
<span class="n">sorted_states_df</span> <span class="o">=</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;State&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;Intuitive_Price_Ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;median&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;Intuitive_Price_Ratio&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">sorted_states_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Intuitive_Price_Ratio</th>
    </tr>
    <tr>
      <th>State</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>NM</th>
      <td>1.147781</td>
    </tr>
    <tr>
      <th>MS</th>
      <td>1.108406</td>
    </tr>
    <tr>
      <th>MT</th>
      <td>1.090499</td>
    </tr>
    <tr>
      <th>WY</th>
      <td>1.055361</td>
    </tr>
    <tr>
      <th>LA</th>
      <td>1.047571</td>
    </tr>
    <tr>
      <th>KS</th>
      <td>1.036582</td>
    </tr>
    <tr>
      <th>VT</th>
      <td>1.036013</td>
    </tr>
    <tr>
      <th>WV</th>
      <td>1.027663</td>
    </tr>
    <tr>
      <th>OK</th>
      <td>1.015508</td>
    </tr>
    <tr>
      <th>SC</th>
      <td>1.015338</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><span class="c1"># states with the worst housing market</span>
<span class="n">sorted_states_df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Intuitive_Price_Ratio</th>
    </tr>
    <tr>
      <th>State</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>RI</th>
      <td>0.939939</td>
    </tr>
    <tr>
      <th>WA</th>
      <td>0.931055</td>
    </tr>
    <tr>
      <th>AK</th>
      <td>0.926371</td>
    </tr>
    <tr>
      <th>ID</th>
      <td>0.924646</td>
    </tr>
    <tr>
      <th>AZ</th>
      <td>0.921471</td>
    </tr>
    <tr>
      <th>HI</th>
      <td>0.915682</td>
    </tr>
    <tr>
      <th>MI</th>
      <td>0.914556</td>
    </tr>
    <tr>
      <th>CA</th>
      <td>0.898245</td>
    </tr>
    <tr>
      <th>FL</th>
      <td>0.880623</td>
    </tr>
    <tr>
      <th>NV</th>
      <td>0.837595</td>
    </tr>
  </tbody>
</table>
</div>

<h3>Best and Worst College Towns Housing Markets</h3>
<p>Silver City, New Mexico, the home of New Mexico Tech, had a median home price increase of 33% the best in the country.  The 27% decline in Riverside, California is the worst of any college town analyzed.  Hopefully, they have fully recovered.  </p>
<div class="highlight"><pre><span></span><span class="c1"># best and worst college towns</span>
<span class="n">sorted_college_df</span> <span class="o">=</span> <span class="n">plot_df</span><span class="p">[</span><span class="n">plot_df</span><span class="o">.</span><span class="n">Town</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;College&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;Intuitive_Price_Ratio&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">top_10</span> <span class="o">=</span> <span class="n">sorted_college_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">top_10</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Location</th>
      <th>State</th>
      <th>Intuitive_Price_Ratio</th>
      <th>Type</th>
      <th>Town</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5840</th>
      <td>(New Mexico, Silver City)</td>
      <td>NM</td>
      <td>1.331176</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>9705</th>
      <td>(Texas, Stephenville)</td>
      <td>TX</td>
      <td>1.215334</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>6991</th>
      <td>(North Dakota, Grand Forks)</td>
      <td>ND</td>
      <td>1.211294</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>5013</th>
      <td>(Montana, Bozeman)</td>
      <td>MT</td>
      <td>1.142552</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>8616</th>
      <td>(Pennsylvania, California)</td>
      <td>PA</td>
      <td>1.122962</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>9693</th>
      <td>(Texas, Lubbock)</td>
      <td>TX</td>
      <td>1.120328</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>5020</th>
      <td>(Montana, Missoula)</td>
      <td>MT</td>
      <td>1.101759</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>2987</th>
      <td>(Indiana, West Lafayette)</td>
      <td>IN</td>
      <td>1.099918</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>9819</th>
      <td>(Utah, Salt Lake City)</td>
      <td>UT</td>
      <td>1.081056</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>9852</th>
      <td>(Vermont, Burlington)</td>
      <td>VT</td>
      <td>1.077434</td>
      <td>True</td>
      <td>College</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><span class="n">bottom_10</span> <span class="o">=</span> <span class="n">sorted_college_df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">bottom_10</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Location</th>
      <th>State</th>
      <th>Intuitive_Price_Ratio</th>
      <th>Type</th>
      <th>Town</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>523</th>
      <td>(California, Sacramento)</td>
      <td>CA</td>
      <td>0.856530</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>1558</th>
      <td>(Florida, Orlando)</td>
      <td>FL</td>
      <td>0.855448</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>2826</th>
      <td>(Indiana, South Bend)</td>
      <td>IN</td>
      <td>0.846934</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>4391</th>
      <td>(Michigan, Flint)</td>
      <td>MI</td>
      <td>0.828449</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>576</th>
      <td>(California, Merced)</td>
      <td>CA</td>
      <td>0.825599</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>963</th>
      <td>(California, Turlock)</td>
      <td>CA</td>
      <td>0.818946</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>6802</th>
      <td>(North Carolina, Cullowhee)</td>
      <td>NC</td>
      <td>0.806439</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>5045</th>
      <td>(Nevada, Las Vegas)</td>
      <td>NV</td>
      <td>0.770192</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>518</th>
      <td>(California, Pomona)</td>
      <td>CA</td>
      <td>0.731259</td>
      <td>True</td>
      <td>College</td>
    </tr>
    <tr>
      <th>862</th>
      <td>(California, Riverside)</td>
      <td>CA</td>
      <td>0.726472</td>
      <td>True</td>
      <td>College</td>
    </tr>
  </tbody>
</table>
</div>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="https://chrisalbon.com/" target="_blank">Chris Albon - Data Science & Artificial Intelligence</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.pbpython.com/" target="_blank">Practical Business Python</a>
    </li>
    <li class="list-group-item">
      <a href="https://www.3blue1brown.com/" target="_blank">Animated Math</a>
    </li>
    <li class="list-group-item">
      <a href="https://flowingdata.com/" target="_blank">Flowing Data</a>
    </li>
    <li class="list-group-item">
      <a href="https://talkpython.fm/" target="_blank">Talk Python To Me</a>
    </li>
    <li class="list-group-item">
      <a href="http://albertocairo.com/" target="_blank">Alberto Cairo</a>
    </li>
    <li class="list-group-item">
      <a href="https://harangdev.github.io/" target="_blank">Data PlayGround</a>
    </li>
    <li class="list-group-item">
      <a href="https://matthewdevaney.com/" target="_blank">Matthew Devaney's Blog</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2019 Rob Osterburg
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-142581046-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->


</body>
</html>